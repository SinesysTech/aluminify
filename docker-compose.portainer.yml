version: "3.8"

# Docker Compose para deploy via Portainer (EFIC)
# Imagem: sinesystec/aluminify:latest (Docker Hub)
#
# Deploy: Portainer > Stacks > Add Stack > paste este arquivo
# IMPORTANTE: Atualize as variÃ¡veis de ambiente antes de subir!

services:
  aluminify:
    image: sinesystec/aluminify:latest
    environment:
      # --- Next.js ---
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0

      # --- Supabase ---
      - NEXT_PUBLIC_SUPABASE_URL=https://wtqgfmtucqmpheghcvxo.supabase.co
      - NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY=sb_publishable_9EAprDqqqbfviEkdLoIybg_0nMRLHjm
      - SUPABASE_URL=https://wtqgfmtucqmpheghcvxo.supabase.co
      - SUPABASE_SECRET_KEY=sb_secret_AoIsjynbBWgLf9gEo9hKaw_5rO0Kz9u

      # --- Auth ---
      - OAUTH_ENCRYPTION_KEY=uFQt/LX+CwQE0gznmnE1OjsiS8kh63jA0n3xMact9Yc=

      # --- Sentry ---
      - SENTRY_AUTH_TOKEN=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

      # --- Analytics (vazio = desativado) ---
      - NEXT_PUBLIC_GA_MEASUREMENT_ID=

      # --- Logging ---
      - LOG_LEVEL=debug
    networks:
      - network_swarm_public
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 0
        window: 120s
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
      labels:
        # Traefik (em deploy.labels para Swarm mode)
        - "traefik.enable=true"
        - "traefik.docker.network=network_swarm_public"
        # HTTP Router
        - "traefik.http.routers.aluminify.rule=Host(`aluminify.sinesys.com.br`)"
        - "traefik.http.routers.aluminify.entrypoints=websecure"
        - "traefik.http.routers.aluminify.tls=true"
        - "traefik.http.routers.aluminify.tls.certresolver=letsencrypt"
        # Service
        - "traefik.http.services.aluminify.loadbalancer.server.port=3000"
        # HTTP to HTTPS redirect
        - "traefik.http.routers.aluminify-http.rule=Host(`aluminify.sinesys.com.br`)"
        - "traefik.http.routers.aluminify-http.entrypoints=web"
        - "traefik.http.routers.aluminify-http.middlewares=redirect-to-https"
        # Middleware
        - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
        - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

networks:
  network_swarm_public:
    external: true
    name: network_swarm_public
